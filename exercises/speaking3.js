// speaking3.js (ES module)
const SHEET_UNITS = "https://docs.google.com/spreadsheets/d/1KaYYyvkjFxVVobRHNs9tDxW7S79-c5Q4mWEKch6oqks/gviz/tq?tqx=out:json";
const SHEET_LESSONS = "https://docs.google.com/spreadsheets/d/1xdGIaXekYFQqm1K6ZZyX5pcrmrmjFdSgTJeW27yZJmQ/gviz/tq?tqx=out:json";
const MIN_UNIT_NUM = 3031;
const PIXABAY_KEY = "51268254-554135d72f1d226beca834413";

let speakingItems = []; // unique name to avoid collisions
let currentIndex = 0;
let score = 0;

// UI refs
const progressBalls = Array.from(document.querySelectorAll('.ball-small'));
const imgEl = document.getElementById('vocabImage');
const hintEl = document.getElementById('hintText');
const targetEl = document.getElementById('targetWord');
const lessonEl = document.getElementById('lessonCode');
const resultEl = document.getElementById('speechResult');
const scoreEl = document.getElementById('scoreValue');
const pokemonEmoteEl = document.getElementById('pokemonEmote');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const recordBtn = document.getElementById('recordBtn');

// Helpers
function normalizeUnitId(unitStr){
  const m = (unitStr || "").trim().match(/^(\d+)-(\d+)-(\d+)$/);
  if (!m) return 0;
  return parseInt(m[1],10)*1000 + parseInt(m[2],10)*10 + parseInt(m[3],10);
}
function normalizeClass(raw){
  const n = parseInt((raw||"").replace(/\D/g,""),10);
  return Number.isFinite(n) ? n : null;
}
function splitTargets(rawTarget){
  return (rawTarget||"").toLowerCase().split(/[/;,]/).map(s=>s.trim()).filter(Boolean);
}
function normText(s){ return (s||"").toLowerCase().replace(/[^a-z0-9'\s]/g,"").trim(); }
function pickRandom(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

async function fetchGVizRows(url){
  console.log("üîó Fetch GViz:", url);
  const res = await fetch(url);
  const txt = await res.text();
  const json = JSON.parse(txt.substring(47).replace(/\);$/, ""));
  const rows = json.table?.rows || [];
  console.log("üì• GViz parsed rows:", rows.length);
  return rows;
}

function numberToUnitStr(num){
  const s = num.toString().padStart(4,"0");
  return `${s[0]}-${s.slice(1,3)}-${s[3]}`;
}

async function getMaxLessonCode(trainerClassRaw){
  const classNum = normalizeClass(trainerClassRaw);
  console.log("üéì TrainerClass raw:", trainerClassRaw, "‚Üí normalized:", classNum);
  if (!classNum) return null;

  const rows = await fetchGVizRows(SHEET_LESSONS);
  console.log("üóÇ Lessons sample:", rows.slice(0,3).map(r=>({A:r.c?.[0]?.v, C:r.c?.[2]?.v})));

  const codes = rows.map(r=>{
    const lopNum = normalizeClass(r.c?.[0]?.v?.toString().trim());
    const baiNum = parseInt(r.c?.[2]?.v?.toString().trim(),10);
    if (lopNum===classNum && Number.isFinite(baiNum)){
      return normalizeUnitId(numberToUnitStr(baiNum));
    }
    return null;
  }).filter(v=>typeof v==="number");

  console.log("üìä Max lesson candidates:", codes);
  return codes.length ? Math.max(...codes) : null;
}

async function fetchPresentationRows(){
  const rows = await fetchGVizRows(SHEET_UNITS);
  console.log("üîé Units first 3 raw (B/C/I):", rows.slice(0,3).map(r=>({
    B:r.c?.[1]?.v, C:r.c?.[2]?.v, I:r.c?.[8]?.v
  })));

  const items = rows.map((r, idx)=>{
    const unitStr = r.c?.[1]?.v?.toString().trim() || "";
    const vocabRaw = r.c?.[2]?.v?.toString().trim() || "";
    const presentation = r.c?.[8]?.v?.toString().trim() || "";
    const unitNum = unitStr ? normalizeUnitId(unitStr) : 0;
    const targets = splitTargets(vocabRaw);

    // Per-row log (requested)
    console.log("üß© Row", idx, { unitStr, vocabRaw, presentation, unitNum, targets });

    return { unitStr, unitNum, targets, presentation };
  }).filter(it=>it.unitStr && it.unitNum && it.presentation);

  console.log("üì¶ Presentation items count:", items.length);
  return items;
}

function makeHint(text){
  const w = (text||"").split(/\s+/).filter(Boolean);
  return (w.slice(0,2).join(" ") || "...") + "...";
}

// Images
const imageCache = {};
function fetchImageForKeyword(keyword){
  const kw = (keyword||"").trim().toLowerCase();
  if (!kw) return Promise.resolve(null);
  const apiUrl = `https://pixabay.com/api/?key=${PIXABAY_KEY}&q=${encodeURIComponent(`${kw} cartoon`)}&image_type=illustration&safesearch=true&per_page=5`;
  console.log("üñºÔ∏è Fetching image:", kw, apiUrl);
  return fetch(apiUrl)
    .then(res=>res.json())
    .then(data=>{
      console.log("üñºÔ∏è Pixabay response:", data);
      if (data.hits?.length){
        const chosen = data.hits[Math.floor(Math.random()*data.hits.length)];
        console.log("üñºÔ∏è Chosen image:", chosen.webformatURL, "for:", kw);
        return { url: chosen.webformatURL, keyword: kw };
      }
      console.warn("‚ö†Ô∏è No image found for:", kw);
      return null;
    })
    .catch(err=>{
      console.error("‚ùå Pixabay error:", err);
      return null;
    });
}

// Build items
async function buildSpeaking3Items() {
  const trainerClassRaw = localStorage.getItem("trainerClass")?.trim() || "";
  const wordBankRaw = localStorage.getItem("wordBank");
  const wordBank = wordBankRaw ? (JSON.parse(wordBankRaw) || []).map(w => normText(w)) : [];

  console.log("üß© trainerClass:", trainerClassRaw);
  console.log("üß© wordBank:", wordBank);

  if (!trainerClassRaw) throw new Error("Thi·∫øu trainerClass (vd: '3' ho·∫∑c 'L·ªõp 3').");
  if (!wordBank.length) throw new Error("wordBank r·ªóng. H√£y set localStorage.wordBank l√† m·∫£ng t·ª´ v·ª±ng.");

  const maxLessonCode = await getMaxLessonCode(trainerClassRaw);
  console.log("üèÅ MaxLessonCode:", maxLessonCode);
  if (!maxLessonCode) throw new Error(`Kh√¥ng t√¨m th·∫•y b√†i l·ªõn nh·∫•t cho l·ªõp "${trainerClassRaw}"`);

  const all = await fetchPresentationRows();
  const classNum = normalizeTrainerClass(trainerClassRaw);

  // Nh√≥m theo b√†i (c·ªôt B: unitStr)
  const unitMap = new Map(); // key: unitStr, value: array of rows [{unitStr, unitNum, targets, presentation}]
  for (const row of all) {
    if (!unitMap.has(row.unitStr)) unitMap.set(row.unitStr, []);
    unitMap.get(row.unitStr).push(row);
  }

  // L·ªçc b√†i h·ª£p l·ªá: ƒë√∫ng l·ªõp, trong kho·∫£ng <= maxLessonCode, c√≥ √≠t nh·∫•t 1 c√¢u thuy·∫øt tr√¨nh
  const eligibleUnits = Array.from(unitMap.entries())
    .filter(([unitStr, rows]) => {
      const unitNum = normalizeUnitId(unitStr);
      const inRange = unitNum >= MIN_UNIT_NUM && unitNum <= maxLessonCode;
      const correctClass = classNum ? unitStr.startsWith(`${classNum}-`) : true;
      const hasPresentation = rows.some(r => !!r.presentation);
      return inRange && correctClass && hasPresentation;
    })
    .map(([unitStr, rows]) => ({ unitStr, unitNum: normalizeUnitId(unitStr), rows }));

  console.log("üìö Eligible units:", eligibleUnits.length);
  console.log("üìö Eligible units sample:", eligibleUnits.slice(0, 5).map(u => u.unitStr));

  if (!eligibleUnits.length) {
    console.warn("üìä Filter stats (units):", {
      MIN_UNIT_NUM,
      countMin: all.filter(it => it.unitNum >= MIN_UNIT_NUM).length,
      countMax: all.filter(it => it.unitNum <= maxLessonCode).length,
      countClass: all.filter(it => classNum ? it.unitStr.startsWith(`${classNum}-`) : true).length,
      countPres: all.filter(it => !!it.presentation).length
    });
    throw new Error("Kh√¥ng c√≥ d·ªØ li·ªáu h·ª£p l·ªá");
  }

  const speakingItems = [];

  // 1) C√¢u ƒë·∫ßu: n·∫øu t√¨m ƒë∆∞·ª£c b√†i ch·ª©a t·ª´ v·ª±ng random trong wordBank, l·∫•y m·ªôt c√¢u t·ª´ b√†i ƒë√≥
  const randomWord = pickRandom(wordBank);
  console.log("üéØ Random word:", randomWord);

  const unitWithWord = eligibleUnits.find(u => u.rows.some(r => r.targets.includes(randomWord)));
  if (unitWithWord) {
    const row = pickRandom(unitWithWord.rows.filter(r => r.presentation));
    const firstTarget = (row.targets.find(t => wordBank.includes(t)) || row.targets[0] || "").trim();
    const firstHint = makeHint(row.presentation);

    console.log("üéØ First from unit:", unitWithWord.unitStr, {
      target: firstTarget, hint: firstHint, text: row.presentation
    });

    const firstImage = await fetchImageForKeyword(firstTarget);
    speakingItems.push({
      fullText: row.presentation,
      hint: firstHint,
      target: firstTarget,
      lesson: unitWithWord.unitStr,
      imageUrl: firstImage?.url || ""
    });

    // Lo·∫°i b√†i n√†y kh·ªèi pool ƒë·ªÉ kh√¥ng tr√πng
    const idx = eligibleUnits.findIndex(u => u.unitStr === unitWithWord.unitStr);
    if (idx >= 0) eligibleUnits.splice(idx, 1);
  } else {
    console.warn("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y b√†i ch·ª©a randomWord. S·∫Ω ch·ªçn to√†n b·ªô t·ª´ pool ng·∫´u nhi√™n.");
  }

  // 2) Ch·ªçn 9 b√†i c√≤n l·∫°i (m·ªói b√†i 1 c√¢u I)
  const shuffledUnits = [...eligibleUnits].sort(() => Math.random() - 0.5);
  const unitsPicked = shuffledUnits.slice(0, Math.max(0, 10 - speakingItems.length)); // ƒë·ªÉ ƒë·ªß 10 t·ªïng

  console.log("üìå Units picked:", unitsPicked.map(u => u.unitStr));

  for (const u of unitsPicked) {
    // Ch·ªâ l·∫•y 1 c√¢u thuy·∫øt tr√¨nh t·ª´ b√†i n√†y
    const rowsWithPresentation = u.rows.filter(r => r.presentation);
    const chosenRow = pickRandom(rowsWithPresentation);
    const target = (chosenRow.targets[0] || "").trim();
    const hint = makeHint(chosenRow.presentation);

    console.log("‚ûï Add from unit:", u.unitStr, { target, hint, text: chosenRow.presentation });

    const img = target ? await fetchImageForKeyword(target) : null;
    speakingItems.push({
      fullText: chosenRow.presentation,
      hint,
      target,
      lesson: u.unitStr,
      imageUrl: img?.url || ""
    });

    if (speakingItems.length >= 10) break;
  }

  console.log("üì¶ Final speakingItems:", speakingItems.length);
  console.log("üì¶ Sample:", speakingItems.slice(0, 3));

  // Prefetch ·∫£nh v√†o cache (n·∫øu d√πng cache)
  const prefetchPromises = speakingItems.map(async it => {
    const key = (it.target || it.fullText || "").trim().toLowerCase();
    if (!imageCache[key] && it.target) {
      const img = await fetchImageForKeyword(it.target);
      if (img?.url) {
        imageCache[key] = img;
        if (!it.imageUrl) it.imageUrl = img.url;
      }
    }
  });
  await Promise.all(prefetchPromises);
  console.log("üóÉÔ∏è ImageCache keys:", Object.keys(imageCache));

  return speakingItems;
}


// Render + scoring
function setActiveProgress(i){
  progressBalls.forEach((b, idx)=> b.classList.toggle('active', idx < i+1));
}
async function render(i){
  const it = speakingItems[i];
  if (!it) return;

  hintEl.textContent = it.hint || "...";
  targetEl.textContent = it.target || "...";
  lessonEl.textContent = it.lesson || "...";

  if (!it.imageUrl && it.target){
    const key = (it.target || it.fullText || "").trim().toLowerCase();
    const cached = imageCache[key];
    if (cached?.url){
      it.imageUrl = cached.url;
      console.log("üñºÔ∏è Use cached image:", cached.url, "for:", key);
    } else {
      const img = await fetchImageForKeyword(it.target);
      it.imageUrl = img?.url || "";
      if (img) imageCache[key] = img;
    }
  }

  imgEl.src = it.imageUrl || "";
  imgEl.alt = it.target || "vocab";
  resultEl.innerHTML = 'K·∫øt qu·∫£ s·∫Ω hi·ªán ·ªü ƒë√¢y.';
  scoreEl.textContent = String(score);
  setActiveProgress(i);

  pokemonEmoteEl.className = 'emote';
  pokemonEmoteEl.textContent = '‚ö°Ô∏è';
}

function checkAccuracy(userText, correctText, targetWord){
  const tWords = normText(correctText).split(/\s+/).filter(Boolean);
  const uSet = new Set(normText(userText).split(/\s+/).filter(Boolean));
  let hit = 0;
  for (const w of tWords) if (uSet.has(w)) hit++;
  const percent = tWords.length ? Math.round((hit/tWords.length)*100) : 0;
  const hasTarget = targetWord ? uSet.has(normText(targetWord)) : false;
  const pass = percent >= 50 || hasTarget;
  return { percent, hit, total: tWords.length, pass, hasTarget };
}

// SpeechRecognition (Speaking 2 style)
let recognition = null;
let isListening = false;
function setupRecognition(){
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition){
    console.warn("‚ö†Ô∏è Browser kh√¥ng h·ªó tr·ª£ SpeechRecognition.");
    return;
  }
  recognition = new SpeechRecognition();
  recognition.lang = "en-US";
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;

  recognition.onstart = ()=>{ isListening = true; resultEl.textContent = "üéôÔ∏è ƒêang nghe..."; };
  recognition.onend = ()=>{ isListening = false; };
  recognition.onerror = (e)=>{ isListening=false; console.error("‚ùå Rec error:", e.error); resultEl.textContent = `‚ùå L·ªói: ${e.error}`; try{ recognition.abort(); }catch{} };
  recognition.onresult = (event)=>{
    const transcript = event.results?.[0]?.[0]?.transcript?.toLowerCase()?.trim() || "";
    const it = speakingItems[currentIndex];
    const { percent, hit, total, pass, hasTarget } = checkAccuracy(transcript, it.fullText, it.target);
    resultEl.innerHTML = `‚úÖ B·∫°n n√≥i: "<i>${transcript}</i>"<br>üéØ ƒê√∫ng ${hit}/${total} t·ª´ ‚Üí <b>${percent}%</b>${it.target ? `<br>üîë T·ª´ v·ª±ng: <b>${it.target}</b> (${hasTarget ? "‚úÖ c√≥" : "‚ùå kh√¥ng"})` : ""}`;

    if (pass){
      score++;
      scoreEl.textContent = String(score);
      pokemonEmoteEl.textContent = '‚ú®';
      pokemonEmoteEl.classList.add('react-good');
    } else {
      pokemonEmoteEl.textContent = 'üíß';
      pokemonEmoteEl.classList.add('react-bad');
    }
    console.log("üßÆ Score update:", { currentIndex, score, percent, pass });
  };
}

// Events
prevBtn.addEventListener('click', async ()=>{
  if (recognition && isListening) { try{ recognition.abort(); }catch{} }
  if (currentIndex > 0){ currentIndex--; await render(currentIndex); }
});
nextBtn.addEventListener('click', async ()=>{
  if (recognition && isListening) { try{ recognition.abort(); }catch{} }
  if (currentIndex < speakingItems.length - 1){ currentIndex++; await render(currentIndex); }
  else {
    const percentTotal = speakingItems.length ? Math.round((score/speakingItems.length)*100) : 0;
    if (percentTotal >= 50){
      resultEl.innerHTML = `üéâ Ho√†n th√†nh! ƒêi·ªÉm: <strong>${score}/${speakingItems.length}</strong> ‚Üí <strong>${percentTotal}%</strong>`;
    } else {
      resultEl.innerHTML = `üö´ Ch∆∞a ƒë·∫°t. ƒêi·ªÉm: <strong>${score}/${speakingItems.length}</strong> ‚Üí <strong>${percentTotal}%</strong>`;
    }
  }
});
recordBtn.addEventListener('click', ()=>{
  if (!recognition){ resultEl.textContent = "‚ö†Ô∏è Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ thu √¢m."; return; }
  if (isListening) return;
  try { recognition.start(); }
  catch(err){
    try{ recognition.abort(); }catch{}
    setTimeout(()=>{ try{ recognition.start(); }catch(e2){ resultEl.textContent="‚ùå Kh√¥ng th·ªÉ b·∫Øt ƒë·∫ßu nh·∫≠n gi·ªçng. Ki·ªÉm tra mic/HTTPS."; } }, 120);
  }
});

// Init
(async function init(){
  try {
    console.log("üöÄ Init Speaking 3");
    setupRecognition();
    speakingItems = await buildSpeaking3Items();
    if (!speakingItems.length){
      resultEl.textContent = "üì≠ Kh√¥ng c√≥ d·ªØ li·ªáu Speaking 3 h·ª£p l·ªá.";
      return;
    }
    currentIndex = 0;
    score = 0;
    await render(currentIndex);
    console.log("‚úÖ Ready. Items:", speakingItems.length);
  } catch (e) {
    console.error("‚ùå Init error:", e);
    resultEl.textContent = "‚ùå Kh√¥ng th·ªÉ kh·ªüi t·∫°o Speaking 3. Ki·ªÉm tra d·ªØ li·ªáu.";
  }
})();

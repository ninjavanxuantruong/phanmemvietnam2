import { initializeApp, getApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

// App 1: Pok√©mon (bosuutap)
const pokemonConfig = {
  apiKey: "AIzaSyCCVdzWiiFvcWiHVJN-x33YKarsjyziS8E",
  authDomain: "pokemon-capture-10d03.firebaseapp.com",
  projectId: "pokemon-capture-10d03",
  storageBucket: "pokemon-capture-10d03.firebasestorage.app",
  messagingSenderId: "1068125543917",
  appId: "1:1068125543917:web:57de4365ee56729ea8dbe4"
};
const pokemonApp = initializeApp(pokemonConfig, "pokemonApp");
const dbPokemon = getFirestore(pokemonApp);

// App 2: L·ªõp h·ªçc th·∫ßy T√¨nh (tonghop)
const lopHocConfig = {
  apiKey: "AIzaSyBQ1pPmSdBV8M8YdVbpKhw_DOetmzIMwXU",
  authDomain: "lop-hoc-thay-tinh.firebaseapp.com",
  projectId: "lop-hoc-thay-tinh",
  storageBucket: "lop-hoc-thay-tinh.firebasestorage.app",
  messagingSenderId: "391812475288",
  appId: "1:391812475288:web:ca4c275ac776d69deb23ed"
};
const lopHocApp = initializeApp(lopHocConfig, "lopHocApp");
const dbLopHoc = getFirestore(lopHocApp);

// ‚úÖ Import d·ªØ li·ªáu Pok√©mon
import { pokemonData } from './pokemonData.js';

// ‚úÖ H√†m ch·ªçn Pok√©mon theo ti·∫øn ho√° v√† t·ªâ l·ªá
function getNextPokemonToCapture(currentList = []) {
  const owned = new Set(currentList);
  const stage1 = pokemonData.filter(p => p.stage === 1);
  const stage2 = pokemonData.filter(p => p.stage === 2);
  const stage3 = pokemonData.filter(p => p.stage === 3);

  if (currentList.length === 0) {
    const starters = stage1.filter(p => !p.evolvesFrom || p.name === "Pikachu");
    const chosen = starters[Math.floor(Math.random() * starters.length)];
    console.log(`üéØ Thu ph·ª•c kh·ªüi ƒë·∫ßu: ${chosen.name}`);
    return chosen;
  }

  const evolvable = pokemonData.filter(p => {
    return p.evolvesFrom && owned.has(p.evolvesFrom) && !owned.has(p.id);
  });

  const evolvableStage2 = evolvable.filter(p => p.stage === 2);
  const evolvableStage3 = evolvable.filter(p => {
    const from = pokemonData.find(x => x.id === p.evolvesFrom);
    return p.stage === 3 && from && owned.has(from.id);
  });

  const pool = [];

  for (let i = 0; i < 6; i++) {
    const candidates = stage1.filter(p => !owned.has(p.id));
    if (candidates.length) pool.push(candidates[Math.floor(Math.random() * candidates.length)]);
  }

  for (let i = 0; i < 3; i++) {
    if (evolvableStage2.length) pool.push(evolvableStage2[Math.floor(Math.random() * evolvableStage2.length)]);
  }

  for (let i = 0; i < 1; i++) {
    if (evolvableStage3.length) pool.push(evolvableStage3[Math.floor(Math.random() * evolvableStage3.length)]);
  }

  const finalPool = pool.filter(Boolean);
  const selected = finalPool[Math.floor(Math.random() * finalPool.length)];
  console.log(`üéØ ƒê√£ ch·ªçn t·ª´ pool: ${selected.name} (stage ${selected.stage})`);
  return selected;
}

// ‚úÖ L·∫•y t√™n v√† l·ªõp t·ª´ localStorage
const studentName = localStorage.getItem("trainerName") || "Kh√¥ng t√™n";
const studentClass = localStorage.getItem("trainerClass") || "Ch∆∞a c√≥ l·ªõp";
document.getElementById("studentName").textContent = studentName;

// ‚úÖ T·∫°o document ID
const docId = `${studentName}-${studentClass}`;

// ‚úÖ L·∫•y sao t·ª´ ƒëi·ªÉm h√¥m qua trong tonghop (lop-hoc-thay-tinh) r·ªìi c·ªông v√†o bosuutap (pokemon-capture-10d03)
async function updateStarsFromYesterday() {
  try {
    const name = localStorage.getItem("trainerName") || "Kh√¥ng t√™n";
    const clazz = localStorage.getItem("trainerClass") || "Ch∆∞a c√≥ l·ªõp";

    const pad = n => String(n).padStart(2, "0");
    const now = new Date();
    const todayCode = `${pad(now.getDate())}${pad(now.getMonth() + 1)}${String(now.getFullYear()).slice(-2)}`;
    const yesterday = new Date(now.getTime() - 86400000);
    const yesterdayCode = `${pad(yesterday.getDate())}${pad(yesterday.getMonth() + 1)}${String(yesterday.getFullYear()).slice(-2)}`;

    console.log(`üìÖ H√¥m nay: ${todayCode} | H√¥m qua: ${yesterdayCode} | HS: ${name} | L·ªõp: ${clazz}`);

    // L·∫•y ƒëi·ªÉm t·ª´ project lop-hoc-thay-tinh
    const refSummary = doc(dbLopHoc, "tonghop", `summary-${clazz}-recent`);
    const snapSummary = await getDoc(refSummary);

    if (!snapSummary.exists()) {
      console.warn(`‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y doc tonghop/summary-${clazz}-recent`);
      return;
    }

    const summaryData = snapSummary.data();
    const dayBucket = summaryData.dayData?.[yesterdayCode];
    if (!dayBucket || !dayBucket[name]) {
      console.warn(`‚ö†Ô∏è Kh√¥ng c√≥ d·ªØ li·ªáu cho ${name} ng√†y ${yesterdayCode}`);
      return;
    }

    const score = parseInt(dayBucket[name].score || 0, 10);
    console.log(`üì¶ ƒêi·ªÉm h√¥m qua c·ªßa ${name}: ${score}`);

    // ‚úÖ C·ªông sao v√†o project pokemon-capture-10d03
    const id = `${name}-${clazz}`;
    const refCollection = doc(dbPokemon, "bosuutap", id);

    // L·∫•y d·ªØ li·ªáu c≈© (n·∫øu c√≥)
    const snapCollection = await getDoc(refCollection);
    const oldData = snapCollection.exists() ? snapCollection.data() : {};

    // N·∫øu h√¥m nay ƒë√£ c·ªông r·ªìi th√¨ b·ªè qua
    if (oldData.lastStarUpdate === todayCode) {
      console.log(`‚è≥ H√¥m nay (${todayCode}) ƒë√£ c·ªông sao r·ªìi. B·ªè qua.`);
      return;
    }

    // T√≠nh s·ªë sao m·ªõi
    const previousStars = parseInt(oldData.stars || 0, 10);
    const newStars = previousStars + score;

    // Ghi l·∫°i d·ªØ li·ªáu m·ªõi
    await setDoc(refCollection, {
      ...oldData,
      stars: newStars,
      lastStarUpdate: todayCode
    });

    // C·∫≠p nh·∫≠t giao di·ªán
    const starEl = document.getElementById("starCount");
    if (starEl) starEl.textContent = newStars;

    console.log(`‚úÖ ƒê√£ c·ªông ${score} sao t·ª´ ng√†y ${yesterdayCode}. ‚≠ê T·ªïng m·ªõi: ${newStars}`);
  } catch (error) {
    console.error("‚ùå L·ªói khi c·∫≠p nh·∫≠t sao:", error.message);
  }
}

// ‚úÖ H√†m t·∫£i d·ªØ li·ªáu t·ª´ Firebase v√† hi·ªÉn th·ªã b·ªô s∆∞u t·∫≠p
async function loadCollection() {
  console.log("üì• ƒêang t·∫£i d·ªØ li·ªáu b·ªô s∆∞u t·∫≠p Pok√©mon...");

  try {
    // D√πng dbPokemon (project pokemon-capture-10d03)
    const ref = doc(dbPokemon, "bosuutap", docId);
    const snap = await getDoc(ref);

    if (!snap.exists()) {
      console.warn("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu h·ªçc sinh:", docId);
      return;
    }

    const data = snap.data();
    console.log("üì¶ D·ªØ li·ªáu b·ªô s∆∞u t·∫≠p:", data);

    document.getElementById("starCount").textContent = data.stars || 0;

    const container = document.getElementById("pokemonCollection");
    container.innerHTML = "";

    (data.pokemons || []).forEach(id => {
      const imgURL = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${id}.png`;
      const card = document.createElement("div");
      card.className = "pokemon-card";
      card.innerHTML = `<img src="${imgURL}" /><div>#${id}</div>`;
      container.appendChild(card);
    });

    console.log("‚úÖ ƒê√£ hi·ªÉn th·ªã b·ªô s∆∞u t·∫≠p Pok√©mon");
    renderCapturedPokemons(data);

    // ‚úÖ G·ªçi c·∫≠p nh·∫≠t sao sau khi t·∫£i xong
    updateStarsFromYesterday();
  } catch (error) {
    console.error("‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu Firebase:", error.message);
  }
}

loadCollection();

// ‚úÖ B·∫Øt ƒë·∫ßu quy tr√¨nh thu ph·ª•c Pok√©mon
document.getElementById("startCaptureBtn").addEventListener("click", async () => {
  console.log("üéØ B·∫Øt ƒë·∫ßu ki·ªÉm tra ƒëi·ªÅu ki·ªán thu ph·ª•c...");

  // D√πng dbPokemon
  const ref = doc(dbPokemon, "bosuutap", docId);
  const snap = await getDoc(ref);

  if (!snap.exists()) {
    alert("‚ùå Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu h·ªçc sinh.");
    return;
  }

  const data = snap.data();
  const currentStars = data.stars || 0;
  const today = new Date().toISOString().slice(0, 10);

  if (currentStars < 500) {
    alert("‚ùå B·∫°n ch∆∞a ƒë·ªß 500 sao ƒë·ªÉ thu ph·ª•c Pok√©mon.");
    console.log("‚ùå Kh√¥ng ƒë·ªß sao ƒë·ªÉ thu ph·ª•c.");
    return;
  }

  // ‚úÖ Tr·ª´ 500 sao v√† ghi l·∫°i
  const newStars = currentStars - 500;
  await setDoc(ref, {
    ...data,
    stars: newStars,
    lastCaptureDate: today
  });

  document.getElementById("starCount").textContent = newStars;
  console.log(`‚úÖ ƒê√£ tr·ª´ 500 sao. C√≤n l·∫°i: ${newStars}`);
  console.log("üß† B·∫Øt ƒë·∫ßu t·∫°o quiz thu ph·ª•c...");

  // ‚úÖ T·∫°o quiz t·ª´ d·ªØ li·ªáu l·ªõp v√† b√†i h·ªçc
  const trainerClass = localStorage.getItem("trainerClass")?.trim();
  console.log(`üì¶ L·ªõp hi·ªán t·∫°i t·ª´ localStorage: ${trainerClass}`);

  const SHEET_BAI_HOC = "https://docs.google.com/spreadsheets/d/1xdGIaXekYFQqm1K6ZZyX5pcrmrmjFdSgTJeW27yZJmQ/gviz/tq?tqx=out:json";
  const res1 = await fetch(SHEET_BAI_HOC);
  const text1 = await res1.text();
  const json1 = JSON.parse(text1.substring(47).slice(0, -2));
  const rows1 = json1.table.rows;

  const baiList = rows1
    .map(r => {
      const lop = r.c[0]?.v?.toString().trim();
      const bai = r.c[2]?.v?.toString().trim();
      return lop === trainerClass && bai ? parseInt(bai) : null;
    })
    .filter(v => typeof v === "number");

  if (baiList.length === 0) {
    console.warn(`‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y b√†i h·ªçc n√†o cho l·ªõp ${trainerClass}`);
    return;
  }

  const maxLessonCode = Math.max(...baiList);
  console.log(`üìà B√†i l·ªõn nh·∫•t c·ªßa l·ªõp ${trainerClass}: ${maxLessonCode}`);

  // ‚úÖ Truy v·∫•n Sheet t·ª´ v·ª±ng
  const SHEET_TU_VUNG = "https://docs.google.com/spreadsheets/d/1KaYYyvkjFxVVobRHNs9tDxW7S79-c5Q4mWEKch6oqks/gviz/tq?tqx=out:json";
  const res2 = await fetch(SHEET_TU_VUNG);
  const text2 = await res2.text();
  const json2 = JSON.parse(text2.substring(47).slice(0, -2));
  const rows2 = json2.table.rows.slice(1); // ‚úÖ B·ªè d√≤ng ƒë·∫ßu ti√™n

  const baiTuVung = {};
  rows2.forEach(r => {
    const rawCode = r.c[1]?.v?.toString().trim();
    const word = r.c[2]?.v?.toString().trim();
    const meaning = r.c[24]?.v?.toString().trim();

    const normalizedCode = parseInt(rawCode?.replace(/\D/g, ""));
    if (!normalizedCode || normalizedCode > maxLessonCode || !word || !meaning) return;

    if (!baiTuVung[normalizedCode]) baiTuVung[normalizedCode] = [];
    baiTuVung[normalizedCode].push({ word, meaning });
  });

  const allCodes = Object.keys(baiTuVung).map(c => parseInt(c));
  console.log("üìö C√°c m√£ b√†i h·ª£p l·ªá:", allCodes);

  const shuffledCodes = allCodes.sort(() => Math.random() - 0.5).slice(0, 20);
  console.log("üéØ C√°c b√†i ƒë∆∞·ª£c ch·ªçn:", shuffledCodes);

  const usedMeanings = new Set();
  const quizItems = [];

  shuffledCodes.forEach(code => {
    const words = baiTuVung[code];
    if (!words || words.length === 0) return;

    const candidates = words.filter(w => !usedMeanings.has(w.meaning));
    if (candidates.length === 0) return;

    const item = candidates[Math.floor(Math.random() * candidates.length)];
    usedMeanings.add(item.meaning);
    quizItems.push(item);
  });

  console.log(`‚úÖ ƒê√£ t·∫°o quiz g·ªìm ${quizItems.length} t·ª´ v·ª±ng.`);

  // ‚úÖ Hi·ªÉn th·ªã quiz
  const container = document.getElementById("quizContainer");
  container.innerHTML = "";
  document.getElementById("quizSection").style.display = "block";

  quizItems.forEach((item, index) => {
    const allMeanings = rows2
      .map(r => r.c[24]?.v?.toString().trim())
      .filter(m => m && m !== item.meaning);

    const wrongOptions = allMeanings.sort(() => Math.random() - 0.5).slice(0, 3);
    const allOptions = [...wrongOptions, item.meaning].sort(() => Math.random() - 0.5);

    const div = document.createElement("div");
    div.className = "quiz-item";
    div.innerHTML = `<strong>C√¢u ${index + 1}:</strong> Nghƒ©a c·ªßa "<em>${item.word}</em>"<br/>`;

    allOptions.forEach((opt, i) => {
      const label = String.fromCharCode(65 + i);
      div.innerHTML += `
        <label>
          <input type="radio" name="q${index}" value="${opt}" data-correct="${item.meaning}" />
          ${label}. ${opt}
        </label><br/>
      `;
    });

    container.appendChild(div);
  });

  console.log(`‚úÖ ƒê√£ t·∫°o quiz t·ª´ ${shuffledCodes.length} b√†i, m·ªói b√†i 1 t·ª´.`);
});

// N√∫t n·ªôp b√†i quiz
document.getElementById("submitQuizBtn").addEventListener("click", async () => {
  const radios = document.querySelectorAll("input[type=radio]:checked");
  let correctCount = 0;

  radios.forEach(r => {
    if (r.value === r.dataset.correct) correctCount++;
  });

  const totalQuestions = document.querySelectorAll(".quiz-item").length;
  const passThreshold = Math.ceil(totalQuestions * 0.8);

  console.log(`üìä S·ªë c√¢u ƒë√∫ng: ${correctCount}/${totalQuestions} | Y√™u c·∫ßu: ‚â•${passThreshold}`);

  if (correctCount >= passThreshold) {
    // D√πng dbPokemon
    const ref = doc(dbPokemon, "bosuutap", docId);
    const snap = await getDoc(ref);
    const data = snap.exists() ? snap.data() : {};
    const currentList = data.pokemons || [];
    const owned = new Set(currentList);

    const newPokemonObj = getNextPokemonToCapture(currentList);
    const newPokemon = newPokemonObj.id;
    let updatedList = [...currentList];
    let message = "";

    if (newPokemonObj.evolvesFrom && owned.has(newPokemonObj.evolvesFrom)) {
      updatedList = updatedList.filter(id => id !== newPokemonObj.evolvesFrom);
      message = `‚ú® Ti·∫øn ho√° l√™n ${newPokemonObj.name}!`;
      console.log(`üîÅ Ti·∫øn ho√°: ${newPokemonObj.evolvesFrom} ‚Üí ${newPokemon}`);
    } else {
      message = `‚úÖ Thu ph·ª•c th√†nh c√¥ng ${newPokemonObj.name}!`;
      console.log(`üÜï Thu ph·ª•c m·ªõi: ${newPokemonObj.name}`);
    }

    updatedList.push(newPokemon);

    await setDoc(ref, {
      ...data,
      pokemons: updatedList,
      selected: newPokemon,
      stage: newPokemonObj.stage
    });

    // ‚úÖ T·∫°o hi·ªáu ·ª©ng Pok√©Ball
    const pokeball = document.createElement('img');
    pokeball.src = 'https://cdn-icons-png.flaticon.com/512/361/361998.png';
    pokeball.alt = 'Pok√©Ball';
    pokeball.style.position = 'fixed';
    pokeball.style.top = '50%';
    pokeball.style.left = '50%';
    pokeball.style.transform = 'translate(-50%, -50%)';
    pokeball.style.height = '120px';
    pokeball.style.zIndex = '1000';
    pokeball.style.animation = 'shake 1s ease-in-out 3';
    document.body.appendChild(pokeball);

    const style = document.createElement('style');
    style.innerHTML = `
      @keyframes shake {
        0%, 100% { transform: translate(-50%, -50%) rotate(0deg); }
        25% { transform: translate(-50%, -50%) rotate(10deg); }
        50% { transform: translate(-50%, -50%) rotate(-10deg); }
        75% { transform: translate(-50%, -50%) rotate(10deg); }
      }
      @keyframes summon {
        from { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
        to { opacity: 1; transform: translate(-50%, -50%) scale(1.4); }
      }
    `;
    document.head.appendChild(style);

    // ‚úÖ Hi·ªán Pok√©mon sau hi·ªáu ·ª©ng
    setTimeout(() => {
      pokeball.remove();

      const pokemonImg = document.createElement('img');
      pokemonImg.src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${newPokemon}.png`;
      pokemonImg.alt = newPokemonObj.name;
      pokemonImg.style.position = 'fixed';
      pokemonImg.style.top = '50%';
      pokemonImg.style.left = '50%';
      pokemonImg.style.transform = 'translate(-50%, -50%)';
      pokemonImg.style.height = '140px';
      pokemonImg.style.zIndex = '1000';
      pokemonImg.style.animation = 'summon 0.6s ease-out';
      document.body.appendChild(pokemonImg);

      setTimeout(() => {
        alert(message);
        window.location.reload();
      }, 1000);
    }, 3000);
  } else {
    alert("‚ùå B·∫°n ch∆∞a ƒë·ªß ƒëi·ªÉm ƒë·ªÉ thu ph·ª•c Pok√©mon.");
    console.log("‚ùå Kh√¥ng v∆∞·ª£t qua b√†i ki·ªÉm tra.");

    document.getElementById("quizSection").style.display = "none";
    document.getElementById("quizContainer").innerHTML = "";
  }
});

function renderCapturedPokemons(data) {
  const container = document.getElementById("pokemonCollection");
  const infoBox = document.getElementById("selectedPokemonInfo");
  container.innerHTML = "";
  infoBox.textContent = "";

  const captured = data.pokemons || [];
  const selectedId = data.selected;

  captured.forEach(id => {
    const p = pokemonData.find(p => p.id === id);
    if (!p) return;

    const card = document.createElement("div");
    card.className = "pokemon-card";
    card.innerHTML = `
      <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${p.id}.png" alt="${p.name}" class="pokemon-img" data-id="${p.id}" />
      <p>#${p.id} - ${p.name}</p>
      <button class="battle-btn" data-id="${p.id}">Ch·ªçn ƒë·ªÉ xu·∫•t chi·∫øn</button>
    `;

    // D√πng dbPokemon
    card.querySelector("button").addEventListener("click", async () => {
      const ref = doc(dbPokemon, "bosuutap", docId);
      await setDoc(ref, {
        ...data,
        selected: p.id
      });

      infoBox.textContent = `üõ°Ô∏è B·∫°n ƒëang ch·ªçn Pok√©mon ${p.name} (#${p.id}) ƒë·ªÉ xu·∫•t chi·∫øn`;
      console.log(`‚úÖ ƒê√£ ch·ªçn Pok√©mon ${p.name} (#${p.id}) ƒë·ªÉ xu·∫•t chi·∫øn`);
    });

    container.appendChild(card);
    card.querySelector(".pokemon-img").addEventListener("click", () => {
      showPokemonDetail(p.id);
    });

    if (p.id === selectedId) {
      infoBox.textContent = `üõ°Ô∏è B·∫°n ƒëang ch·ªçn Pok√©mon ${p.name} (#${p.id}) ƒë·ªÉ xu·∫•t chi·∫øn`;
    }
  });
}

function showPokemonDetail(id) {
  const poke = pokemonData.find(p => p.id === id);
  if (!poke) return;

  const html = `
    <h2>${poke.name} (#${poke.id})</h2>
    <p>üî∞ H·ªá: ${poke.type}</p>
    <p>Stage: ${poke.stage} ‚Äì K√≠ch th∆∞·ªõc: ${poke.size}</p>
    <p>‚ù§Ô∏è HP: ${poke.hp} ‚Äì ‚öîÔ∏è Power: ${poke.power}</p>
    <p>üéØ K·ªπ nƒÉng: ${poke.skills.join(", ")}</p>
    <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${poke.id}.png" style="margin-top:10px;" />
  `;

  document.getElementById("popupContentInner").innerHTML = html;
  document.getElementById("pokemonDetailPopup").style.display = "block";
}

document.getElementById("closePopupBtn").addEventListener("click", () => {
  document.getElementById("pokemonDetailPopup").style.display = "none";
});
